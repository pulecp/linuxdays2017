<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Deployment of HA loadbalancer - HAProxy + Let's Encrypt</title>

    <meta name="author" content="Pavel Pulec">

    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="./css/reveal.min.css">
    <link rel="stylesheet" href="./css/theme/simple.css" id="theme">
    <link rel="stylesheet" href="./css/reveal.custom.css">


    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="./lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write('<link rel="stylesheet" href="./css/print/' + ( window.location.search.match(/print-pdf/gi) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">');
    </script>

    <!--[if lt IE 9]>
    <script src="./lib/js/html5shiv.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="./css/kayn.css">
</head>

<body>

<div class="reveal">

    <!-- Any section element inside of this container is displayed as a slide -->
    <div class="slides">

        <section>
            <h2>Deployment of HA loadbalancer</h2>
            <h2>-</h2>
            <h2>HAProxy + Let's Encrypt</h2>
            <h5>Pavel Pulec</h5>
        </section>

        <section>
            <section>
                <h2>About me</h2>
            </section>

            <section>
                <h3>Pavel Pulec</h3>
                <ul>
                    <li>linux administrator @inuits.{cz,be,eu,nl}</li>
                    <li>Puppet, HA, MongoDB, GlusterFS, Jenkins, Icinga, ELK, RabbitMQ, Apache Storm, automatization, ...</li>
                    <li>kayn@inuits.cz</li>
                </ul>
            </section>

        </section>

        <section>
            <section>
                <h2>HA stack</h2>
            </section>

            <section>
                 <img src="./img/01_basic.svg" width="50%">
            </section>

            <section>
                 <img src="./img/02_basic_with_server.svg" width="50%">
            </section>

            <section>
                <h3>HAProxy</h3>
                <ul>
                    <li>loadbalancer, reverse proxy</li>
                    <li>de facto standard of open-source loadbalancers</li>
                    <li>TCP, HTTP</li>
                    <li>100k+ simultaneous connections per second</li>
                    <li>automatically choose TLS/SSL certificate</li>
                    <li>couple of load balancing algorithms</li>
                    <li>hot reconfiguration (v1.7)</li>
                    <li>no caching!</li>
                </ul>
            </section>

            <section>
                 <img src="./img/03_one_haproxy.svg" width="100%">
            </section>

            <section>
                 <img src="./img/04_one_haproxy_crash.svg" width="100%">
            </section>

            <section>
                 <img src="./img/05_two_haproxy.svg" width="80%">
            </section>

            <section>
                <h3>HA by DNS</h3>
                <ul>
                    <li>DNS returns more IP addresses</li>
                    <pre>
<code class="bash">kayn@t460:~$ dig microsoft.com +short
104.40.211.35
23.100.122.175
23.96.52.53
191.239.213.197
104.43.195.251</code></pre>
                    <li>DNS caching</li>
                    <li>theoretically 1/2 of clients is out of service when one server dies</li>
                    <li>no traffic control</li>
                    <li>both HAProxies are used - problems with sticky sessions</li>
                </ul>
            </section>

            <section>
                 <img src="./img/06_two_haproxy_active_passive.svg" width="80%">
            </section>

            <section>
                <h3>HA by failover IP address</h3>
                <ul>
                    <li>public IP address routable to any your server</li>
                    <li>provided by OVH or Hetzner</li>
                    <li>manageable over admin console in browser or API</li>
                    <li>downtime less than 1s when changing routing</li>
                </ul>
            </section>

            <section>
                 <img src="./img/07_two_haproxy_pacemaker.svg" width="100%">
            </section>

            <section>
                <h3>Pacemaker</h3>
                <ul>
                    <li>scalable program to manage resources on clusters</li>
                    <li>monitoring of services (i.e. over systemd or own scripts)</li>
                    <li>automatic detection and recovery</li>
                    <li>records accidents</li>
                    <li>communication with OVH/Hetzner API by Pacemaker:</li>
                    <ul>
                        <li><a href="https://github.com/tux-o-matic/ovhipfailover">https://github.com/tux-o-matic/ovhipfailover</a></li>
                        <li><a href="https://blog.kumina.nl/2011/02/hetzner-failover-ip-ocf-script">https://blog.kumina.nl/2011/02/hetzner-failover-ip-ocf-script</a></li>
                    </ul>
                </ul>
            </section>

            <section>
                <h3>Pacemaker - configuration</h3>
<pre><code class="crmsh">[root@haproxy01.example.com ~]# crm configure show
node 1: haproxy01.example.com
node 2: haproxy02.example.com
primitive haproxy systemd:haproxy \
	params \
	op monitor interval=10s \
	op start interval=0 on-fail=restart timeout=30s
primitive ovh_vip ocf:inuits:ovh-failover-ip \
	params ip=203.0.113.1 script="/usr/local/sbin/ovh_ip_failover.py" \
	op monitor interval=10s timeout=20s \
	op start interval=0 on-fail=restart timeout=180s \
	op stop interval=0s timeout=20s
clone haproxy-clone haproxy \
	meta clone-max=2
colocation colocation-ovh_vip-haproxy-clone-INFINITY inf: ovh_vip haproxy-clone
...</code></pre>
            </section>

            <section>
                <h3>HA properties</h3>
                <ul>
                    <li>24/7 availability</li>
                    <li>option to re-route the traffic in a case of maintenance</li>
                    <li>active/passive mode of HAProxy</li>
                    <ul>
                        <li>real data on stats page</li>
                        <li>easy management over stats page</li>
                    </ul>
                    <li>own implementation of whole stack</li>
                    <li>?vendor lock-in?</li>
                </ul>
            </section>
        </section>


        <section>
            <section>
                <h2>Let's Encrypt</h2>
            </section>

            <section>
                <h3>Let's Encrypt</h3>
                <ul>
                    <li>free, open and automated certificate authority</li>
                    <li>enough to control DNS or webserver to request a certificate</li>
                    <li>verification over HTTP - be careful with a redirection from HTTP to HTTPS</li>
                    <li>certificate is valid 3 months</li>
                    <li>automatic re-newing (cronjob)</li>
                    <li>wildcard certificates are finally supported</li>
                    <li>you should back up certificates</li>
                    <li>rate-limits (<a href="https://letsencrypt.org/docs/rate-limits/">https://letsencrypt.org/docs/rate-limits</a>)</li>
                </ul>
            </section>

            <section>
                <h3>Certbot</h3>
                <ul>
                    <li>the tool to get certificates from authorities using ACME protocol</li>
                    <li>available in common distributions (RHEL/CentOS 7 - EPEL)</li>
                    <li>supports apache/2.x and nginx/0.8.48+</li>
                    <li>plugins
                    <ul>
                        <li>apache - get and configure</li>
                        <li>nginx - get and configure</li>
                        <li>webroot - uses webroot of running webserver</li>
                        <li>standalone - runs own webserver on port 80 or 443</li>
                        <li>manual</li>
                    </ul>
                </ul>
            </section>

            <section>
                 <img src="./img/07_two_haproxy_pacemaker.svg" width="100%">
            </section>

            <section>
                 <img src="./img/08_two_haproxy_pacemaker_simpler.svg" width="100%">
            </section>

            <section>
                <h3>HAProxy configuration</h3>
<pre><code class="nginx">frontend http-in
  bind 0.0.0.0:443 ssl crt /self_sign.pem ssl crt /etc/pki/tls/haproxy/
  bind 0.0.0.0:80
  mode http
  use_backend letsencrypt if { path_beg -i /.well-known/acme-challenge/ }
  redirect scheme https code 301 if !{ ssl_fc } { hdr(host) -i example.com www.example.com }
  use_backend backend_app if { hdr(host) -i example.com www.example.com }

listen letsencrypt
  mode http
  balance roundrobin
  server haproxy01 192.168.0.10:9999
  server haproxy02 192.168.0.11:9999

listen backend_app
  mode http
  balance leastconn
  http-check expect rstatus (2..)
  server webserver01 192.168.0.20:80 check
  server webserver02 192.168.0.21:80 check</code></pre>
            </section>

            <section>
                <h3>HAProxy configuration - frontend</h3>
<pre><code class="nginx">frontend http-in
  bind 0.0.0.0:443 ssl crt /self_sign.pem ssl crt /etc/pki/tls/haproxy/
  bind 0.0.0.0:80
  mode http
  use_backend letsencrypt if { path_beg -i /.well-known/acme-challenge/ }
  redirect scheme https code 301 if !{ ssl_fc } { hdr(host) -i example.com www.example.com }
  use_backend backend_app if { hdr(host) -i example.com www.example.com }</code></pre>
                <ul>
                    <li>self-signed certificate by default /self_sign.pem</li>
                    <li>other certificates in /etc/pki/tls/haproxy/</li>
                    <li>authentication requests from LE ends on "letsencrypt" backend</li>
                </ul>
            </section>

            <section>
                <h3>HAProxy configuration - backend</h3>
<pre><code class="nginx">listen letsencrypt
  mode http
  balance roundrobin
  option redispatch
  server haproxy01 192.168.0.10:9999
  server haproxy02 192.168.0.11:9999</code></pre>
                <ul>
                    <li>authentication requests end on HAProxy on port 9999</li>
                    <li><code>option redispatch</code> - automatically redirect a request to another available server (enabled by default)</li>
                </ul>
            </section>

            <section>
                <h3>How to request certificate</h3>
                <pre><code class="bash">cert_path=/etc/letsencrypt/live/example.com/
haproxy_path=/etc/pki/tls/haproxy/

certbot --text --agree-tos certonly -a standalone \
--keep-until-expiring -d example.com -d www.example.com --non-interactive \
--standalone-supported-challenges http-01 --http-01-port 9999 |
grep "Congratulations" &&
cat $cert_path/{fullchain.pem,privkey.pem} > $haproxy_path/example.com.pem &&
/sbin/service haproxy reload</code></pre>
                <ul>
                    <li>runs in cron on both HAProxy</li>
                </ul>
            </section>

            <section>
                 <img src="./img/10_two_haproxy_first_certbot.svg" width="100%">
            </section>

            <section>
                 <img src="./img/11_two_haproxy_first_req.svg" width="100%">
            </section>

            <section>
                 <img src="./img/12_two_haproxy_first_done.svg" width="100%">
            </section>

            <section>
                 <img src="./img/13_two_haproxy_second_certbot.svg" width="100%">
            </section>

            <section>
                 <img src="./img/14_two_haproxy_second_fir_req.svg" width="100%">
            </section>

            <section>
                 <img src="./img/15_two_haproxy_second_sec_req.svg" width="100%">
            </section>

            <section>
                 <img src="./img/16_two_haproxy_second_done.svg" width="100%">
            </section>

            <section>
                <h3>Let's Encrypt on HA HAProxy - properties</h3>
                <ul>
                    <li>fully automated and configurable</li>
                    <li>duplicate certificates! (limit 5 certificates/week)</li>
                    <li>private key is on server/VM only</li>
                    <li>no need to back up a certificate</li>
                </ul>
            </section>

        </section>

        <section>
            <h3>Questions?</h3>
            <ul>
                <li>slides: <a href="https://pulecp.github.io/linuxdays2017/">https://pulecp.github.io/linuxdays2017/</a></li>
                <li>kayn@inuits.cz</li>
                <li>Thanks for attention!</li>
            </ul>
            <img src="./img/inuits_default_logo-nofont.svg" width="30%">
        </section>

        <section>
            <h3>Sources</h3>
            <ul>
                <li><a href="http://www.haproxy.org/">http://www.haproxy.org/</a></li>
                <li><a href="https://certbot.eff.org/">https://certbot.eff.org/</a></li>
                <li><a href="https://github.com/certbot/certbot">https://github.com/certbot/certbot</a></li>
                <li><a href="https://letsencrypt.org/">https://letsencrypt.org/</a></li>
                <li><a href="https://blog.kumina.nl/2011/02/hetzner-failover-ip-ocf-script">https://blog.kumina.nl/2011/02/hetzner-failover-ip-ocf-script</a></li>
            </ul>
        </section>



    </div>

</div>

<script src="./lib/js/head.min.js"></script>
<script src="./js/reveal.min.js"></script>

<script>

  // Full list of configuration options available here:
  // https://github.com/hakimel/reveal.js#configuration
  Reveal.initialize({
    controls: true,
    progress: true,
    history: true,
    center: true,

    theme: Reveal.getQueryHash().theme, // available themes are in //css/theme
    transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none

    // Optional libraries used to extend on reveal.js
    dependencies: [
      {
        src: './lib/js/classList.js', condition: function () {
        return !document.body.classList;
      }
      },
      {
        src: './plugin/markdown/showdown.js', condition: function () {
        return !!document.querySelector('[data-markdown]');
      }
      },
      {
        src: './plugin/markdown/markdown.js', condition: function () {
        return !!document.querySelector('[data-markdown]');
      }
      },
      {
        src: './plugin/highlight/highlight.js', async: true, callback: function () {
        hljs.initHighlightingOnLoad();
      }
      },
      {
        src: './plugin/zoom-js/zoom.js', async: true, condition: function () {
        return !!document.body.classList;
      }
      },
      {
        src: './plugin/notes/notes.js', async: true, condition: function () {
        return !!document.body.classList;
      }
      }
      //{ src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
    ]
  });

</script>

</body>
</html>
